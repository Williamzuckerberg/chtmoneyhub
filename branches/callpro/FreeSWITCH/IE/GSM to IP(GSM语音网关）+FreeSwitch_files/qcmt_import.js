qing.registNS("qcmt");qcmt.cmtRequestMgr=(function(){var c={cmtList:qDomain.qing+"/qcmt/data/cmtlist",cmtAdd:qDomain.qing+"/qcmt/submit/createcmt",cmtDelete:qDomain.qing+"/qcmt/submit/deletecmt",repostAdd:qDomain.qing+"/pub/submit/createrepost"};function e(i){var g=[];for(var h in i){if(typeof h=="undefined"){g.push(h)}}if(g.length){return new Error("Parameter Undefine Error: "+g.join("  "))}}function a(g,h){var i=g.thread_id_enc;var j=g.count;e({thread_id_enc:i,count:j});var k={thread_id_enc:i,start:g.start||0,count:g.count,orderby_type:(typeof g.orderby_type=="undefined")?1:g.orderby_type,favor:typeof g.favor=="undefined"?2:g.favor,type:"smblog"};qing.ajax.request(c.cmtList,{data:k,noCache:true,onsuccess:h.onsuccess,onerror:h.onerror,onfailure:h.onfailure,onexception:h.onexception,ontimeout:h.ontimeout})}function d(k,g){if(qVisitorInfo.loginStatus=="not_login"){qui.showLogin();return}else{if(qVisitorInfo.loginStatus!="activated"){qui.showActive();return}}var h=k.thread_id_enc;var i=k.content;e({thread_id_enc:h,content:i});var j={thread_id_enc:h,parent_id_enc:k.parent_id_enc||0,content:i,mms_flag:k.mms_flag||0,replyee_portrait:k.replyee_portrait,host_portrait:k.host_portrait,type:"smblog"};qing.ajax.request(c.cmtAdd,{method:"post",data:j,onsuccess:g.onsuccess,onerror:g.onerror,onfailure:g.onfailure,onexception:g.onexception,ontimeout:g.ontimeout})}function b(i,g){if(qVisitorInfo.loginStatus=="not_login"){qui.showLogin();return}else{if(qVisitorInfo.loginStatus!="activated"){qui.showActive();return}}var h=i.thread_id_enc;var j=i.reply_id_enc;e({thread_id_enc:h,reply_id_enc:j});qing.ajax.request(c.cmtDelete,{method:"post",data:{thread_id_enc:h,reply_id_enc:j,type:"smblog"},onsuccess:g.onsuccess,onerror:g.onerror,onfailure:g.onfailure,onexception:g.onexception,ontimeout:g.ontimeout})}function f(j,g){if(qVisitorInfo.loginStatus=="not_login"){qui.showLogin();return}else{if(qVisitorInfo.loginStatus=="not_activate"){qui.showActive();return}}var h=j.thread_id_enc;var i=j.reason;e({thread_id_enc:h,reason:i});qing.ajax.request(c.repostAdd,{method:"post",data:j,onsuccess:g.onsuccess,onerror:g.onerror,onfailure:g.onfailure,onexception:g.onexception,ontimeout:g.ontimeout})}return{cmtList:a,cmtAdd:d,cmtDelete:b,repostAdd:f}})();qing.registNS("qcmt");qcmt.tpl=(function(){var i=['<div id="#{cmtWraperId}" class="qcmt-wraper-box-comment">','<div class="cmt-border-top"></div>','<div class="qcmt-arrow-wraper" style="left:#{arrowLeft}px;">','<div class="qcmt-arrow-border"></div>','<div class="qcmt-arrow-shadow"></div>','<div class="qcmt-arrow"></div>','<div class="qcmt-arrow-inner"></div>',"</div>",'<div class="qcmt-input-box clearfix">','<div class="qcmt-input-textarea-box">','<div class="qcmt-textarea-wraper">','<div class="qcmt-textarea-minishadow">','<textarea class="qcmt-textarea-box"></textarea>',"</div>","</div>",'<div class="qcmt-input-textnum-tip right hide">','<span class="num-box num-total">500</span>','<span class="num-box num-l">/</span>','<span class="num-box now-num">0</span>',"</div>",'<div class="qcmt-input-repost-checkbox left">','<div class="qcmt-reply-friend hide">','<input type="checkbox" name="comment" class="qcmt-reply-friend-check" id="repostCheckFriend#{checkIndex}" checked />&nbsp;','<label for="repostCheckFriend#{checkIndex}">同时评论给&nbsp; #{friendName}</label>',"</div>",'<div class="qcmt-reply-author hide">','<input type="checkbox" name="comment" class="qcmt-reply-author-check" id="repostCheckAuthor#{checkIndex}" checked />&nbsp;','<label for="repostCheckAuthor#{checkIndex}">同时评论给原文作者&nbsp; #{authorName}</label>',"</div>","</div>","</div>",'<div class="qcmt-sub-bt-box">','<a href="#" class="cmt-add button button-save button-cmt clearfix"><span class="button-left">&#160;</span><span class="button-text">发布</span><span class="button-right">&#160;</span></a>',"</div>","</div>",'<div class="qcmt-main-wraper">','<div class="qcmt-main-box">#{cmtListContent}','<div class="qcmt-list-wraper">#{cmtListContent}</div>','<div class="qcmt-footer-wraper">#{footer}</div>',"</div>","</div>","</div>"].join("");var b=['<div class="qcmt-footer-box clearfix">','<a class="qcmt-collapse" href="#">','<span class="collapse-arrow"></span>','<span class="collapse-tip">收起</span>',"</a>",'<span class="qcmt-vl #{isSeemoreHideClass}">|</span>','<a class="cmt-seemore cmt-seenext #{isSeemoreHideClass}" href="#{seemoreUrl}" target="_blank">','<span class="seemore-arrow hide"></span>','<span class="seemore-tip">查看更多</span>',"</a>",'<span class="seemore-loading hide"></span>',"</div>"].join("");var h='<div class="cmt-list">#{cmtList}</div>';var g='<a href="#" class="cmt-delete #{isHoverShowClass}">删除</a>';var d='<a href="#" class="cmt-reply #{isReplyHideClass}">回复</a>';var f=['<a class="cmt-item-portrait" href="#{userUrl}" title="#{userName}" data-user-id="#{userId}" target="_blank">','<img alt="#{userName}" src="#{imgUrl}"/>',"</a>",'<div class="cmt-content-box">','<div class="cmt-content-detail">#{cmtDetailTpl}</div>','<div class="cmt-pub-time">#{cmtPubTime}</div>','<div class="cmt-control-box">',"#{controlBoxTpl}","</div>","</div>"].join("");var c=['<div class="cmt-item"  data-cmt-id="#{cmtId}" id="#{cmtId}">','<div class="cmt-item-content clearfix">',f,"</div>",'<div class="cmt-mini-border"></div>',"</div>"].join("");var a='<a class="cmt-user-name" href="#{userUrl}" target="_blank">#{userName}</a>#{summary}<span class="wise-ico #{isWiseIcoShowClass}" title="来自空间手机版">&nbsp;</span>';var e=['<div class="cmt-actor-info clearfix">','<a class="cmt-replyer-name" href="#{userUrl}" title="#{userName}" target="_blank">#{userName}</a><span class="cmt-reply-tip">回复</span><a href="#{replyeeUrl}" title="#{replyeeName}" class="cmt-replyee-name" target="_blank">#{replyeeName}</a>',"</div>",'<div class="cmt-summary">#{summary}<span class="wise-ico #{isWiseIcoShowClass}" title="来自空间手机版">&nbsp;</span></div>'].join("");return{wraper:i,cmtList:h,cmtItemInner:f,cmtItem:c,cmtDetailTpl:a,cmtReplyDetailTpl:e,cmtFooter:b,cmtDeleteTpl:g,cmtReplyTpl:d}})();qing.registNS("qcmt");qcmt.Base=qing.lang.createClass(function(b,c,a){this.elem=b;this.target=c.target;this.numElem=c.numElem;this.extraNumElem=c.extraNumElem;this.threadId=c.threadId;this.userInfo=c.userInfo;this.actorPortrait=c.actorPortrait;this.actorName=c.actorName;this.actorQingUrl=c.actorQingUrl;this.cmtWraperId=c.cmtWraperId;this.focus=c.focus;this.bindTargetEvent=c.bindTargetEvent;this.callback=c.callback;this.engineListenObj={};this.contentType=c.contentType;this.originAuthor=c.originAuthor;this.originThreadId=c.originThreadId;this.repostSuccess=c.repostSuccess},{}).extend({format:function(){},engineListen:function(){var a=this;qing.array.each(["click","mouseover","mouseout","keyup","focus","blur","paste","cut","input"],function(e){qing.on(a.cmtWraperId,e,function(g){var f=g.target||g.srcElement;if(!f){return false}for(var i in a.engineListenObj[e]){var h=a.engineListenObj[e][i];if((f.className&&qing.dom.hasClass(f,i))){h.apply(f,[g,a]);break}else{if(ancestor=qext.fn.getAncestorByClass(f,i)){h.apply(ancestor,[g,a]);break}}}});if(e=="focus"||e=="blur"){for(var d in a.engineListenObj[e]){var b=qing.dom.q(d,qing.g(a.cmtWraperId));if(!b){return false}var c=a.engineListenObj[e][d];qing.array.each(b,function(g,f){qing.event.on(g,e,function(h){c.apply(g,[h,a])})})}}})}});qing.registNS("qcmt");qcmt.Repost=(function(){var b=function(j){var m=200,k=2,i=k*2+1;var l=function(){i--;if(i%2==0){qing.dom.addClass(j,"input-box-warning")}else{qing.dom.removeClass(j,"input-box-warning")}if(i<1){qing.dom.removeClass(j,"input-box-warning");return}setTimeout(l,m)};l()};var d=function(o,j){qing.event.preventDefault(o);if(j.elem.cmtCreating||j.elem.cmtCrashing){return}var n=qing.dom.query(".qcmt-textarea-box",j.elem)[0];var m=n.value;var k=m;if(m.length==0){}if(qing.string.getByteLength(m)>280){qui.showAlert("转载理由字数过多");return}var l=qing.dom.query(".qcmt-reply-friend-check",j.elem)[0];var i=qing.dom.query(".qcmt-reply-author-check",j.elem)[0];var p=l.checked||i.checked;if(p&&m.length==0){b(n);return}j.elem.cmtCrashing=true;qcmt.cmtRequestMgr.repostAdd({thread_id_enc:j.threadId,reason:m},{onfailure:function(){if(j&&j.elem){j.elem.cmtCrashing=false}},onerror:function(q){if(j&&j.elem){j.elem.cmtCrashing=false}if(parseInt(q.errorNo,10)==102){return}qui.showError(q.errorMsg)},onsuccess:function(){qui.showSuccess("转载成功");n.value="";n.focus();if(j.numElem){var r=/(\d+)/.exec(j.numElem.innerHTML);var v=qing.dom.getAttr(j.numElem,"data-prefix"),s=qing.dom.getAttr(j.numElem,"data-suffix");if(v===null){v="("}if(s===null){s=")"}if(r&&r[1]){j.numElem.innerHTML=v+(parseInt(r[1])+1)+s}else{j.numElem.innerHTML=v+"1"+s}qing.dom.hasClass(j.numElem,"hide")&&qing.dom.removeClass(j.numElem,"hide");j.numElem.style.display=""}j.elem.style.overflow="hidden";var q=qani.animate(j.elem,{height:j.elem.offsetHeight+"px$tween:strongAccelerate"},{height:0},300);q.on("finish",function(){j.elem.style.display="none";j.elem.style.overflow="visible";j.elem.style.height="0";j.elem.cmtCrashing=false});j.elem.targetElem=null;var u=qing.dom.query(".qcmt-reply-friend-check",j.elem)[0];var t=qing.dom.query(".qcmt-reply-author-check",j.elem)[0];if(u.checked){qcmt.cmtRequestMgr.cmtAdd({thread_id_enc:j.threadId,content:k,host_portrait:j.actorPortrait},{onsuccess:function(y){if(j.extraNumElem){var w=/(\d+)/.exec(j.extraNumElem.innerHTML);var z=qing.dom.getAttr(j.numElem,"data-prefix"),x=qing.dom.getAttr(j.numElem,"data-suffix");if(z===null){z="("}if(x===null){x=")"}if(w&&w[1]){j.extraNumElem.innerHTML=z+(parseInt(w[1])+1)+x}else{j.extraNumElem.innerHTML=z+"1"+x}qing.dom.hasClass(j.extraNumElem,"hide")&&qing.dom.removeClass(j.extraNumElem,"hide");j.extraNumElem.style.display=""}j.repostSuccess&&j.repostSuccess(y,j,k)}})}if(t.checked&&j.originAuthor&&j.originThreadId){qcmt.cmtRequestMgr.cmtAdd({thread_id_enc:j.originThreadId,content:k,host_portrait:j.originAuthor.portrait},{onsuccess:function(w){}})}}})};var e=function(k,i){var j=k.which||k.keyCode;if(k.ctrlKey&&j==13){d.call(this,k,i)}};var h=function(j,i){var k=qing.dom.query(".qcmt-textarea-wraper",i.elem)[0];qing.dom.addClass(k,"focus")};var g=function(j,i){var k=qing.dom.query(".qcmt-textarea-wraper",i.elem)[0];qing.dom.removeClass(k,"focus")};var c=function(j,i){qing.dom.addClass(this,"mouseover")};var a=function(j,i){qing.dom.removeClass(this,"mouseover")};var f={click:{"cmt-add":d},keyup:{"qcmt-textarea-box":e},mouseover:{"qcmt-textarea-wraper":c},mouseout:{"qcmt-textarea-wraper":a},focus:{"qcmt-textarea-box":h},blur:{"qcmt-textarea-box":g}};return qing.lang.createClass(function(){this.engineListenObj=f},{superClass:qcmt.Base}).extend({format:function(){var t=this;var r=t.actorName||"";var p="";if(t.originAuthor){p=t.originAuthor.name}var m=qing.string.format(qcmt.tpl.wraper,{cmtWraperId:t.cmtWraperId,arrowLeft:qing.dom.getPosition(t.target).left-qing.dom.getPosition(t.elem).left+5,cmtListContent:"",footer:"",friendName:r,authorName:p,checkIndex:qing.lang.guid()});t.elem.style.overflow="hidden";t.elem.style.height=t.elem.offsetHeight+"px";t.elem.innerHTML=m;var i=qing.g(t.cmtWraperId);var n=qani.animate(t.elem,{height:i.offsetHeight},300);n.on("finish",function(){t.elem.style.overflow="visible";t.elem.style.height="auto";var u=qing.dom.query(".qcmt-textarea-box",t.elem)[0];if(t.focus){u.focus()}t.callback&&t.callback();t.elem.cmtCreating=false});var l=qing.dom.query(".qcmt-textarea-box",t.elem)[0];var o=qing.dom.query(".qcmt-input-textnum-tip",t.elem)[0];o.style.display="block";var j=qing.dom.query(".now-num",o)[0];var k=qing.dom.query(".num-total",o)[0];k.innerHTML="140";qext.textarea({autoHeight:true,element:l,autoRender:true,gbkMaxSize:140,callback:function(v){var u=Math.ceil(v/2);j.innerHTML=u;j.style.color=u>=140?"#F46E6E":"#999"}});var s=qing.dom.query(".qcmt-reply-friend",t.elem)[0];var q=qing.dom.query(".qcmt-reply-author",t.elem)[0];qing.dom.removeClass(s,"hide");if(t.contentType=="repost"&&t.originAuthor&&t.originAuthor.name!=qVisitorInfo.userName&&t.originAuthor.name!=t.actorName){qing.dom.removeClass(q,"hide")}}})})();qing.registNS("qcmt");qcmt.Comment=(function(){var g=function(A,x){qing.event.preventDefault(A);var D=this;var u=x.elem;var w=qext.fn.getAncestorByClass(D,"cmt-item");var y=qing.dom.query(".cmt-item-portrait",w)[0];var C=qing.dom.query("img",y)[0];var v=qing.dom.query(".qcmt-textarea-box",u)[0];var t=qing.dom.getPosition(u).top-70;var p=T.browser.isWebkit?document.body:document.documentElement;var s=p.scrollTop;if(s>t){var z=t<0?0:t;p.scrollTop=z}var q=qing.dom.getAttr(y,"title");v.value="回复 "+q+"：";x.toReplyeeId=qing.dom.getAttr(y,"data-user-id");x.toCmtId=qing.dom.getAttr(w,"data-cmt-id");x.toReplyeeName=q;x.toUrl=qing.dom.getAttr(y,"href");x.toUserId=qing.dom.getAttr(y,"data-user-id");var B=v.value.length;if(typeof(v.selectionStart)=="undefined"){var o=v.createTextRange();o.moveStart("character",B);o.collapse(true);o.select()}else{v.selectionStart=v.selectionEnd=B;v.focus()}};var a=function(s,q){var p=this;qing.event.preventDefault(s);var o=qing.dom.query(".qcmt-textarea-box",q.elem)[0];var r=o.value;if(q.toReplyeeId){if(r.indexOf("回")==0){r=r.replace("回复 "+q.toReplyeeName+"：","")}else{q.toReplyeeId=""}}if(r.length==0){qui.showAlert("请输入评论");return}if(qing.string.getByteLength(r)>1000){qui.showAlert("评论字数过多");return}qcmt.cmtRequestMgr.cmtAdd({thread_id_enc:q.threadId,content:r,parent_id_enc:q.toCmtId,replyee_portrait:q.toReplyeeId,host_portrait:q.actorPortrait},{onsuccess:function(B){var t="";if(q.toReplyeeId){t=qing.string.format(qcmt.tpl.cmtReplyDetailTpl,{userUrl:qDomain.qing+"/go/check?portrait="+q.userInfo.portrait,userName:q.userInfo.userName,replyeeUrl:q.toUrl,replyeeName:q.toReplyeeName,summary:qing.string.filterFormat.escapeString(r),isWiseIcoShowClass:"hide"})}else{t=qing.string.format(qcmt.tpl.cmtDetailTpl,{userUrl:qDomain.qing+"/go/check?portrait="+q.userInfo.portrait,userName:q.userInfo.userName,summary:qing.string.filterFormat.escapeString(r),isWiseIcoShowClass:"hide"})}var u="";if(B&&B[0]&&B[0].replyIdEnc){u=B[0].replyIdEnc}else{return}var w=[];if(q.userInfo.portrait==q.actorPortrait){w.push(qing.string.format(qcmt.tpl.cmtDeleteTpl,{isHoverShowClass:"delete-hover-show"}))}var x=qing.string.format(qcmt.tpl.cmtItem,{userUrl:qDomain.qing+"/go/check?portrait="+q.userInfo.portrait,userId:q.userInfo.portrait,userName:q.userInfo.userName,imgUrl:q.userInfo.avatar,cmtDetailTpl:t,cmtId:u,cmtPubTime:qing.date.format(new Date(B[0].cdatetime*1000),"yyyy-MM-dd HH:mm"),controlBoxTpl:w.join("")});var D=qing.dom.query(".cmt-list",q.elem)[0];qing.dom.insertHTML(D,"afterBegin",x);var z=qing.dom.query(".cmt-item",D)[0];var y=z.offsetHeight;qing.dom.setStyles(z,{height:"0px",overflow:"hidden"});var A=qani.animate(z,{height:y+"px"},200);A.on("finish",function(){qing.dom.setStyles(z,{height:"auto",overflow:"visible"})});q.toReplyeeId="";q.toCmtId="";q.toReplyeeName="";o.value="";o.focus();if(q.numElem){var E=/(\d+)/.exec(q.numElem.innerHTML);var v=qing.dom.getAttr(q.numElem,"data-prefix"),C=qing.dom.getAttr(q.numElem,"data-suffix");if(v===null){v="("}if(C===null){C=")"}if(E&&E[1]){q.numElem.innerHTML=v+(parseInt(E[1])+1)+C}else{q.numElem.innerHTML=v+"1"+C}qing.dom.hasClass(q.numElem,"hide")&&qing.dom.removeClass(q.numElem,"hide");q.numElem.style.display=""}}})};var c=function(q,p){qing.event.preventDefault(q);var o=this;var r=new qui.tip.Tip({target:o,anchor:"top",msg:'<div style="text-align:center;width:160px;color:#999;">确认删除这条评论吗?</div>',buttons:[{text:"确定",type:"green",handler:function(){var u=p.threadId;var t=qext.fn.getAncestorByClass(o,"cmt-item");var s=qing.dom.getAttr(t,"data-cmt-id");qcmt.cmtRequestMgr.cmtDelete({thread_id_enc:u,reply_id_enc:s},{onsuccess:function(x){qui.showSuccess("删除成功");t.style.display="none";if(p.numElem){var v=/(\d+)/.exec(p.numElem.innerHTML);if(v&&v[1]){var y=parseInt(v[1])-1;var z=qing.dom.getAttr(p.numElem,"data-prefix"),w=qing.dom.getAttr(p.numElem,"data-suffix");if(z===null){z="("}if(w===null){w=")"}p.numElem.innerHTML=z+y+w;if(!y){p.numElem.style.display="none"}else{qing.dom.hasClass(p.numElem,"hide")&&qing.dom.removeClass(p.numElem,"hide");p.numElem.style.display=""}}else{p.numElem.style.display="none"}}}});r.close()}},{text:"取消",type:"silver",handler:function(){r.close()}}]});r.show()};var j=function(r,q){qing.event.preventDefault(r);var p=this;var o=qing.dom.query(".seemore-loading",q.elem)[0];(qing.dom.hasClass(o,"hide"))&&qing.dom.removeClass(o,"hide");qcmt.cmtRequestMgr.cmtList({thread_id_enc:q.threadId,count:q.count,start:q.nowPage*q.count},{onsuccess:function(v){var v=v[0];var t=v.total_count;var x=v.items;var u=x.length;var w=[];q.nowPage+=1;if(u<q.count){p.style.display="none";qing.dom.query(".qcmt-vl",q.elem)[0].style.display="none"}else{if((q.nowPage*q.count)>q.max){qing.dom.removeClass(p,"cmt-seenext")}}qing.array.each(x,function(A,z){var B="";if(A.replyee_portrait){B=qing.string.format(qcmt.tpl.cmtReplyDetailTpl,{userUrl:qDomain.qing+A.qurl,userName:A.un,replyeeUrl:qDomain.qing+A.replyee_qurl,replyeeName:A.replyee_name,summary:A.content,isWiseIcoShowClass:A.reserved1&&parseInt(A.reserved1)==1?"":"hide"})}else{B=qing.string.format(qcmt.tpl.cmtDetailTpl,{userUrl:qDomain.qing+A.qurl,userName:A.un,summary:A.content,isWiseIcoShowClass:A.reserved1&&parseInt(A.reserved1)==1?"":"hide"})}var C=C;var y=[];if(q.userInfo.portrait==q.actorPortrait){y.push(qing.string.format(qcmt.tpl.cmtDeleteTpl,{isHoverShowClass:"delete-hover-show"}))}if(q.userInfo.portrait!=A.portrait){y.push(qing.string.format(qcmt.tpl.cmtReplyTpl,{isReplyHideClass:""}))}w.push(qing.string.format(qcmt.tpl.cmtItem,{userUrl:qDomain.qing+A.qurl,userName:A.un,imgUrl:A.avatar,cmtDetailTpl:B,cmtId:A.reply_id_enc,threadId:q.threadId,userId:A.portrait,cmtPubTime:qing.date.format(new Date(A.cdatetime*1000),"yyyy-MM-dd HH:mm"),controlBoxTpl:y.join("")}))});var s=qing.dom.query(".cmt-list",q.elem)[0];qing.dom.insertHTML(s,"beforeEnd",w.join(""));(!qing.dom.hasClass(o,"hide"))&&qing.dom.addClass(o,"hide")}})};var k=function(u,r){qing.event.preventDefault(u);if(r.elem.cmtCreating||r.elem.cmtCrashing){return}r.elem.cmtCrashing=true;var t=r.target;var q=qing.dom.getPosition(r.elem).top-100;var v=T.browser.isWebkit?document.body:document.documentElement;var s=v.scrollTop;if(s>q){var p=q<0?0:q;v.scrollTop=p}r.elem.style.overflow="hidden";var o=qani.animate(r.elem,{height:r.elem.offsetHeight+"px$tween:strongAccelerate"},{height:0},300);o.on("finish",function(){r.elem.style.display="none";r.elem.style.overflow="visible";r.elem.style.height="0";r.elem.cmtCrashing=false});r.elem.targetElem=null};var h=function(p,o){qing.event.preventDefault(p);if(qVisitorInfo.loginStatus!="activated"){return}if(o.userInfo.portrait==o.actorPortrait){qing.dom.addClass(this,"mouseover")}};var d=function(p,o){qing.event.preventDefault(p);if(qVisitorInfo.loginStatus!="activated"){return}if(o.userInfo.portrait==o.actorPortrait){qing.dom.removeClass(this,"mouseover")}};var l=function(q,o){var p=q.which||q.keyCode;if(q.ctrlKey&&p==13){a.call(this,q,o)}};var e=function(p,o){var q=qing.dom.query(".qcmt-textarea-wraper",o.elem)[0];qing.dom.addClass(q,"focus")};var n=function(p,o){var q=qing.dom.query(".qcmt-textarea-wraper",o.elem)[0];qing.dom.removeClass(q,"focus")};var m=function(p,o){qing.dom.addClass(this,"mouseover")};var b=function(p,o){qing.dom.removeClass(this,"mouseover")};var f=function(p,o){qing.event.stop(p);return false};var i={click:{"cmt-reply":g,"cmt-add":a,"cmt-delete":c,"cmt-seenext":j,"qcmt-collapse":k},mouseover:{"cmt-item":h,"qcmt-textarea-wraper":m},mouseout:{"cmt-item":d,"qcmt-textarea-wraper":b},focus:{"qcmt-textarea-box":e},blur:{"qcmt-textarea-box":n},keyup:{"qcmt-textarea-box":l},paste:{"qcmt-textarea-box":f}};return qing.lang.createClass(function(p,o){this.engineListenObj=i;this.nowPage=0;this.count=o.count;this.toReplyeeId="";this.toCmtId="";this.toReplyeeName="";this.max=o.max},{superClass:qcmt.Base}).extend({format:function(){var p=this;var t=qing.string.format(qcmt.tpl.wraper,{cmtWraperId:p.cmtWraperId,arrowLeft:qing.dom.getPosition(p.target).left-qing.dom.getPosition(p.elem).left+5,cmtListContent:"",footer:""});p.elem.style.height=p.elem.offsetHeight+"px";p.elem.style.overflow="hidden";p.elem.innerHTML=t;var o=qing.dom.query(".qcmt-textarea-box",p.elem)[0];var s=qing.dom.query(".qcmt-input-textnum-tip",p.elem)[0];var r=qing.dom.query(".now-num",s)[0];qext.textarea({autoHeight:true,element:o,autoRender:true,gbkMaxSize:500,callback:function(w){var v=Math.ceil(w/2);if(v>400){r.innerHTML=Math.ceil(w/2);s.style.display="block";if(v>=500){r.style.color="#F46E6E"}else{r.style.color="#999"}}else{s.style.display="none"}}});function u(A){A&&(A=A[0]);var C=A.total_count;var D=A.items;var E=D.length;var x=[];p.nowPage+=1;qing.array.each(D,function(K,J){var L="";if(K.replyee_portrait){L=qing.string.format(qcmt.tpl.cmtReplyDetailTpl,{userUrl:qDomain.qing+K.qurl,userName:K.un,replyeeUrl:qDomain.qing+K.replyee_qurl,replyeeName:K.replyee_name,summary:K.content,isWiseIcoShowClass:K.reserved1&&parseInt(K.reserved1)==1?"":"hide"})}else{L=qing.string.format(qcmt.tpl.cmtDetailTpl,{userUrl:qDomain.qing+K.qurl,userName:K.un,summary:K.content,isWiseIcoShowClass:K.reserved1&&parseInt(K.reserved1)==1?"":"hide"})}var M=M;var I=[];if(p.userInfo.portrait==p.actorPortrait){I.push(qing.string.format(qcmt.tpl.cmtDeleteTpl,{isHoverShowClass:"delete-hover-show"}))}if(p.userInfo.portrait!=K.portrait){I.push(qing.string.format(qcmt.tpl.cmtReplyTpl,{isReplyHideClass:""}))}x.push(qing.string.format(qcmt.tpl.cmtItem,{userUrl:qDomain.qing+K.qurl,userName:K.un,imgUrl:K.avatar,cmtDetailTpl:L,cmtId:K.reply_id_enc,threadId:p.threadId,userId:K.portrait,cmtPubTime:qing.date.format(new Date(K.cdatetime*1000),"yyyy-MM-dd HH:mm"),controlBoxTpl:I.join("")}))});var H=qing.string.format(qcmt.tpl.cmtFooter,{isSeemoreHideClass:(D.length==0||D.length<p.count)?"hide":"",seemoreUrl:qDomain.qing+p.actorQingUrl+"/item/"+p.threadId+"#reply"});var B=qing.string.format(qcmt.tpl.cmtList,{cmtList:x.join("")});var F=qing.dom.query(".qcmt-list-wraper",p.elem)[0];var y=qing.dom.query(".qcmt-footer-wraper",p.elem)[0];F.innerHTML=B;y.innerHTML=H;var v=qing.g(p.cmtWraperId);var z=qani.animate(p.elem,{height:v.offsetHeight},400);z.on("finish",function(){p.elem.style.overflow="visible";p.elem.style.height="auto";var I=qing.dom.query(".qcmt-textarea-box",p.elem)[0];if(p.focus){I.focus()}p.callback&&p.callback();p.elem.cmtCreating=false});if(p.numElem){if(C&&C!="0"){var w=qing.dom.getAttr(p.numElem,"data-prefix"),G=qing.dom.getAttr(p.numElem,"data-suffix");if(w===null){w="("}if(G===null){G=")"}p.numElem.innerHTML=w+C+G;qing.dom.hasClass(p.numElem,"hide")&&qing.dom.removeClass(p.numElem,"hide")}else{(!qing.dom.hasClass(p.numElem,"hide"))&&qing.dom.addClass(p.numElem,"hide")}}}function q(v){var v=[{total_count:"0",real_ret_count:"",items:[]}];u(v)}qcmt.cmtRequestMgr.cmtList({thread_id_enc:p.threadId,count:p.count},{onsuccess:u,onerror:q,onfailure:q,onexception:q,ontimeout:q})}})})();qing.registNS("qcmt");qcmt.build=(function(){var b={};var a=false;return function(e,g,c){if(e.cmtCreating||e.cmtCrashing){return}if(e.targetElem&&g.target==e.targetElem){return null}e.cmtCreating=true;var j=qVisitorInfo;j.avatar=qVisitorAvatar.size20;var m={userInfo:j,target:g.target,numElem:g.numElem,extraNumElem:g.extraNumElem||null,type:g.type||"comment",threadId:g.id,actorPortrait:g.actorPortrait,actorName:g.actorName,actorQingUrl:g.actorQingUrl,count:g.count||10,max:g.max||200,callback:g.callback,focus:(typeof g.focus=="undefined")?true:g.focus,bindTargetEvent:(typeof g.bindTargetEvent=="undefined")?true:g.bindTargetEvent,cmtWraperId:"qcmt"+parseInt((Math.random()+1)*1000000),contentType:g.contentType||"text",originAuthor:g.originAuthor||null,originThreadId:g.originThreadId||"",repostSuccess:g.repostSuccess};var f=m.type=="repost"?new qcmt.Repost(e,m):new qcmt.Comment(e,m);if(!a){if(c){for(var l in c){if(b[l]){var d=c[l];var k=b[l];for(var h in d){k[h]=d[h]}}else{b[l]=c[l]}}}qext.stylesheet(b);a=true}e.style.display="block";f.format();f.engineListen();if(!e.targetElem){e.targetElem=m.target}var i=function(n){if(e.cmtCreating||e.cmtCrashing){return}if(e.targetElem&&m.target==e.targetElem){e.cmtCrashing=true;setTimeout(function(){var p=m.target;m.bindTargetEvent&&qing.event.un(m.target,"click",i);e.targetElem=null;e.style.overflow="hidden";var o=qani.animate(e,{height:e.offsetHeight+"px$tween:strongAccelerate"},{height:0},300);o.on("finish",function(){e.style.display="none";e.style.overflow="visible";e.style.height="0";e.cmtCrashing=false})},0)}};m.bindTargetEvent&&qing.event.on(m.target,"click",i);e.targetElem=m.target;return{destroy:function(){i()}}}})();