
(function($){var keys={up:38,down:40,enter:13,tab:9,esc:27};var hideTimer;var showing=false;var suggestionsKey='combobox_suggestions';var optionsContainer;$.fn.combobox=function(suggestions,config){config=$.extend({imageUrl:'dropdown.gif'},config);if(!optionsContainer){optionsContainer=$('<ul id="comboboxDropdown" />').appendTo($('body'));if($.fn.bgiframe)
optionsContainer.bgiframe();}
$(this).each(function(i){var $$=this;var textBox=$($$);var oldSuggestions=$.data($$,suggestionsKey);$.data($$,suggestionsKey,suggestions);if(oldSuggestions)
return;textBox.attr('autocomplete','off').focus(function(){show('');}).blur(blur).keydown(keydown).keyup(keyup);var container=textBox.wrap('<div class="combobox" />').parent();var additionalHeight=$.browser.msie?5:3;var button=$('<img class="button" src="'+config.imageUrl+'" />').insertAfter(textBox).css({height:textBox.height()+additionalHeight}).click(function(){textBox.focus();});textBox.width(textBox.width()-button.width());var oriValue;function show(filter){if(hideTimer){window.clearTimeout(hideTimer);hideTimer=0;}
oriValue=textBox.val();hide();var html='';var suggestions=$.data($$,suggestionsKey);for(var k in suggestions){var v=suggestions[k];if((!filter)||(filter&&v.toLowerCase().indexOf(filter.toLowerCase())>=0)){html+='<li>'+v+'</li>';}}
var loc={left:textBox.offset().left,top:textBox.offset().top+textBox.height()+3,width:textBox.width()+button.width()}
optionsContainer.html(html).css(loc);selIndex=0;var found=false;var options=optionsContainer.children('li').each(function(i){if(found)return;if($(this).text().toLowerCase()==oriValue.toLowerCase()){$(this).addClass('selected');selIndex=i;found=true;}});if(!options.size()){hide();return;}
if(!found)
options.eq(0).addClass('selected');options.click(function(){textBox.val($(this).text());}).hover(function(){options.each(function(){$(this).removeClass('selected');});$(this).addClass('selected');selIndex=options.index(this);});if(!filter)
optionsContainer.slideDown();else
optionsContainer.show();showing=true;}
var selIndex;function keydown(evt){switch(evt.keyCode){case keys.esc:hide();textBox.val(oriValue);evt.preventDefault();return;case keys.enter:choose();evt.preventDefault();return;case keys.tab:choose();return;case keys.up:goup();return;case keys.down:godown();return;}}
var oldVal='';function keyup(evt){var v=$(this).val();if(v!=oldVal){show(oldVal=v);}}
function godown(){if(showing){var options=optionsContainer.children('li');var n=options.size();if(!n)
return;selIndex++;if(selIndex>n-1)
selIndex=0;var v=options.eq(selIndex);if(v.size()){options.each(function(){$(this).removeClass('selected')});v.addClass('selected');}}else{show('');}}
function goup(){if(showing){var options=optionsContainer.children('li');var n=options.size();if(!n)
return;selIndex--;if(selIndex<0)
selIndex=n-1;var v=options.eq(selIndex);if(v.size()){options.each(function(){$(this).removeClass('selected')});v.addClass('selected');}}else{show('');}}
function choose(){if(showing){var v=$('li',optionsContainer).eq(selIndex);if(v.size()){textBox.val(v.text());oldVal=v.text();hide();}}}
function hide(){if(showing){optionsContainer.hide().children('li').each(function(){$(this).remove();});showing=false;}}
function blur(){if(!hideTimer){hideTimer=window.setTimeout(hide,300);}}});};})(jQuery);